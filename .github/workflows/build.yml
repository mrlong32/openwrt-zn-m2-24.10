name: ZN-M2 OpenWRT 24.10 编译（全依赖修复版）

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 缓存编译环境
        uses: actions/cache@v3
        id: env-cache
        with:
          path: |
            ~/.ccache
            ./openwrt
          key: ${{ runner.os }}-openwrt-znm2-full-fix-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-openwrt-znm2-full-fix-

      - name: 安装系统依赖
        if: steps.env-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
            file wget curl ccache

      - name: 获取OpenWRT源码并确保源正确（核心修复）
        if: steps.env-cache.outputs.cache-hit != 'true'
        run: |
          # 克隆源码
          git clone https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          git checkout openwrt-24.10
          echo "=== 当前源码分支: $(git branch --show-current)"
          
          # 强制重置feeds配置，只保留必要源
          echo "=== 重置feeds配置 ==="
          cat > feeds.conf.default << 'EOF'
          src-git base https://github.com/openwrt/base.git
          src-git packages https://github.com/openwrt/packages.git
          src-git luci https://github.com/openwrt/luci.git
          src-git routing https://github.com/openwrt/routing.git
          # 禁用有问题的telephony源
          # src-git telephony https://github.com/openwrt/telephony.git
          EOF
          cat feeds.conf.default  # 显示最终的feeds配置
          
          # 彻底清理旧feeds缓存，避免干扰
          echo "=== 清理旧feeds缓存 ==="
          rm -rf feeds packages/feeds
          
          # 强制更新feeds，确保packages源被正确拉取
          echo "=== 强制更新feeds ==="
          ./scripts/feeds update -a -f || { echo "feeds更新失败"; exit 1; }
          
          # 验证packages源是否存在（关键检查）
          echo "=== 验证packages源路径 ==="
          if [ ! -d "feeds/packages" ]; then
            echo "错误：packages源未被拉取，feeds列表："
            ls -l feeds/  # 显示所有拉取的源
            exit 1
          fi
          
          # 安装所有基础包，包括缺失的依赖
          echo "=== 安装所有基础包 ==="
          ./scripts/feeds install -a || { echo "基础包安装失败"; exit 1; }
          
          # 单独安装所有缺失的依赖包（逐个确认）
          echo "=== 安装缺失的依赖包 ==="
          missing_packages=(
            libcrypt       # 核心加密库
            libev          # audit依赖
            libpam         # busybox/policycoreutils依赖
            libtirpc       # busybox依赖
            liblzma        # kexec-tools依赖
            libnetsnmp     # lldpd依赖
            lm-sensors     # autocore依赖
            glib2          # pcat-manager依赖
            libgpiod       # pcat-manager依赖
          )
          
          for pkg in "${missing_packages[@]}"; do
            echo "=== 安装 $pkg ==="
            ./scripts/feeds install "$pkg" || { 
              echo "错误：$pkg 安装失败，搜索可用包：";
              ./scripts/feeds search "$pkg";
              exit 1;
            }
          done
          
          # 最终验证libcrypt路径（确保packages源正常工作）
          echo "=== 验证libcrypt安装路径 ==="
          LIBcrypt_PATH=$(find feeds/packages/ -name "libcrypt" -type d)
          if [ -z "$LIBcrypt_PATH" ]; then
            echo "错误：仍未找到libcrypt，已安装包列表："
            ./scripts/feeds list-installed | grep crypt
            exit 1
          fi
          echo "=== libcrypt路径：$LIBcrypt_PATH ==="

      - name: 集成LibWRT与设备树
        run: |
          cd openwrt
          
          if [ ! -d "package/libwrt" ]; then
            git clone https://github.com/LiBwrt/openwrt-6.x.git package/libwrt
            cd package/libwrt
            git checkout k6.12-nss
            cd ../..
          fi
          
          # 替换LibWRT中的依赖引用
          find package/libwrt -name "Makefile" -exec sed -i 's/libcrypt-compat/libcrypt/g' {} +
          find package/libwrt -name "Makefile" -exec sed -i 's/libev-dev/libev/g' {} +  # 兼容可能的依赖名差异
          
          # 复制设备树
          DTS_FILE=$(find package/libwrt -name "ipq6000-m2.dts" | head -n1)
          [ -z "$DTS_FILE" ] && { echo "未找到设备树"; exit 1; }
          TARGET_DTS_DIR="target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/"
          mkdir -p $TARGET_DTS_DIR
          cp $DTS_FILE $TARGET_DTS_DIR

      - name: 添加ZN-M2设备定义
        run: |
          cd openwrt
          IMAGE_MK="target/linux/qualcommax/image/ipq60xx.mk"
          sed -i '/qcom_ipq6000_m2/d' $IMAGE_MK
          cat << 'EOF' >> $IMAGE_MK
          define Device/qcom_ipq6000_m2
            $(call Device/FitImage)
            $(call Device/UbiFit)
            DEVICE_VENDOR := ZN
            DEVICE_MODEL := M2
            DEVICE_DTS := qcom/ipq6000-m2
            DEVICE_PACKAGES := kmod-usb3 kmod-usb-dwc3-qcom kmod-leds-gpio
            SUPPORTED_DEVICES += ipq6000-m2
          endef
          TARGET_DEVICES += qcom_ipq6000_m2
          EOF
          grep "qcom_ipq6000_m2" $IMAGE_MK || { echo "设备定义失败"; exit 1; }

      - name: 配置编译目标（全依赖勾选）
        run: |
          cd openwrt
          rm -f .config
          
          # 基础配置
          echo "CONFIG_TARGET_qualcommax=y" >> .config
          echo "CONFIG_TARGET_qualcommax_ipq60xx=y" >> .config
          echo "CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_qcom_ipq6000_m2=y" >> .config
          
          # 强制勾选所有依赖包
          echo "CONFIG_PACKAGE_libcrypt=y" >> .config
          echo "CONFIG_PACKAGE_libev=y" >> .config
          echo "CONFIG_PACKAGE_libpam=y" >> .config
          echo "CONFIG_PACKAGE_libtirpc=y" >> .config
          echo "CONFIG_PACKAGE_liblzma=y" >> .config
          echo "CONFIG_PACKAGE_libnetsnmp=y" >> .config
          echo "CONFIG_PACKAGE_lm-sensors=y" >> .config
          echo "CONFIG_PACKAGE_glib2=y" >> .config
          echo "CONFIG_PACKAGE_libgpiod=y" >> .config
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_libwrt=y" >> .config
          
          make defconfig
          
          # 验证所有依赖是否被正确勾选
          echo "=== 验证关键依赖配置 ==="
          for pkg in libcrypt libev libpam libtirpc; do
            if ! grep -q "CONFIG_PACKAGE_$pkg=y" .config; then
              echo "错误：$pkg 未被正确配置";
              exit 1;
            fi
          done
          
          # 验证设备配置
          grep "CONFIG_TARGET_DEVICE_qualcommax_ipq60xx_DEVICE_qcom_ipq6000_m2=y" .config \
            || { echo "设备配置失败"; exit 1; }

      - name: 编译固件
        run: |
          cd openwrt
          make -j$(nproc) V=s 2>&1 | tee compile.log
          
          # 检查产物
          find bin/targets/qualcommax/ipq60xx -name "*qcom_ipq6000_m2*.bin" \
            || { echo "未生成目标固件"; exit 1; }

      - name: 上传结果
        uses: actions/upload-artifact@v4
        with:
          name: zn-m2-firmware
          path: |
            openwrt/bin/targets/qualcommax/ipq60xx/*qcom_ipq6000_m2*.bin
            openwrt/compile.log
          retention-days: 7
    
